<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
    <link rel="stylesheet" href="/style.css">
    <title>Bootstrap 4 Login/Register Form</title>
    <style>
        /* sign in FORM */
        #logreg-forms {
            width: 412px;
            margin: 10vh auto;
            background-color: #f3f3f3;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            transition: all 0.3s cubic-bezier(.25,.8,.25,1);
        }

            #logreg-forms form {
                width: 100%;
                max-width: 410px;
                padding: 15px;
                margin: auto;
            }

            #logreg-forms .form-control {
                position: relative;
                box-sizing: border-box;
                height: auto;
                padding: 10px;
                font-size: 16px;
            }

                #logreg-forms .form-control:focus {
                    z-index: 2;
                }

            #logreg-forms .form-signin input[type="email"] {
                margin-bottom: -1px;
                border-bottom-right-radius: 0;
                border-bottom-left-radius: 0;
            }

            #logreg-forms .form-signin input[type="password"] {
                border-top-left-radius: 0;
                border-top-right-radius: 0;
            }

            #logreg-forms .social-login {
                width: 390px;
                margin: 0 auto;
                margin-bottom: 14px;
            }

            #logreg-forms .social-btn {
                font-weight: 100;
                color: white;
                width: 190px;
                font-size: 0.9rem;
            }

            #logreg-forms a {
                display: block;
                padding-top: 10px;
                color: lightseagreen;
            }

            #logreg-forms button[type="submit"] {
                margin-top: 10px;
            }

            #logreg-forms .facebook-btn {
                background-color: #3C589C;
            }

            #logreg-forms .google-btn {
                background-color: #DF4B3B;
            }

            /* Ẩn form reset và signup mặc định */
            #logreg-forms .form-reset,
            #logreg-forms .form-signup {
                display: none;
            }

                #logreg-forms .form-signup .social-btn {
                    width: 210px;
                }

                #logreg-forms .form-signup input {
                    margin-bottom: 2px;
                }

        .form-signup .social-login {
            width: 210px !important;
            margin: 0 auto;
        }

        /* CSS cho modal OTP */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* Nền mờ */
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.5);
            text-align: center;
            width: 90%;
            max-width: 400px;
        }

            .modal-content h2 {
                margin-bottom: 20px;
            }

            .modal-content input {
                margin-bottom: 15px;
            }

            .modal-content button {
                margin: 5px;
            }

        /* Loading spinner */
        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
    </style>
</head>
<body>
    <div id="logreg-forms">
        <!-- Form Đăng nhập -->
        <form class="form-signin" asp-controller="LoginASignUp" asp-action="LoginGG" method="post">
            <h1 class="h3 mb-3 font-weight-normal" style="text-align: center"> Sign in</h1>

            <div class="social-login">
                <button class="btn google-btn social-btn" type="submit"><span><i class="fab fa-google-plus-g"></i> Sign in with Google+</span> </button>
            </div>

            <input type="text" name="username" id="inputUsername" class="form-control" placeholder="Username" autofocus="">
            <input type="password" name="password" id="inputPassword" class="form-control" placeholder="Password" autofocus="">

            <button class="btn btn-success btn-block" type="submit" formaction="/LoginASignUp/Login" formmethod="post">
                <i class="fas fa-sign-in-alt"></i> Sign in
            </button>

            @if (!string.IsNullOrEmpty(ViewBag.Message1))
            {
                <div class="alert alert-danger text-center">
                    @ViewBag.Message1
                </div>
            }

            @if (TempData["Message2"] != null)
            {
                <div class="alert alert-danger text-center">
                    @TempData["Message2"]
                </div>
            }

            @if (TempData["SuccessMessage"] != null)
            {
                <div class="alert alert-success text-center">
                    @TempData["SuccessMessage"]
                    <script>
                        setTimeout(function () {
                            window.location.href = '@Url.Action("Index", "LoginASignUp")';
                        }, 3000);
                    </script>
                </div>
            }

            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger text-center">
                    @TempData["ErrorMessage"]
                </div>
            }

            <a href="#" id="forgot_pswd">Forgot password?</a>
            <hr>
            <button class="btn btn-primary btn-block" type="button" id="btn-signup"><i class="fas fa-user-plus"></i> Sign up New Account</button>
        </form>

        <!-- Form Đặt lại mật khẩu -->
        <form class="form-reset" asp-controller="LoginASignUp" asp-action="ResetPassword" method="post">
            @Html.AntiForgeryToken() <!-- Thêm CSRF token -->
            <input type="text" name="username" id="inputUsername" class="form-control" placeholder="Username" autofocus="">
            <input type="email" name="resetEmail" class="form-control" placeholder="Email address" required />
            <button class="btn btn-primary btn-block" type="submit">Send Email</button>
            <a href="#" id="cancel_reset"><i class="fas fa-angle-left"></i> Back</a>
        </form>

        <!-- Form Đăng ký -->
        <form class="form-signup" asp-controller="LoginASignUp" asp-action="SignUp" method="post">
            @Html.AntiForgeryToken() <!-- Thêm CSRF token -->
            <h1 class="h3 mb-3 font-weight-normal" style="text-align: center">Sign Up</h1>

            <input type="text" id="user-name" name="username" class="form-control" placeholder="User name" required>
            <input type="password" id="user-pass" name="password" class="form-control" placeholder="Password" required>
            <input type="password" id="user-repeatpass" name="repeatPassword" class="form-control" placeholder="Repeat Password" required>
            <input type="email" id="user-email" name="email" class="form-control" placeholder="Email address" required>
            <input type="text" id="user-Phonenumber" name="phoneNumber" class="form-control" placeholder="Phonenumber" required>
            <input type="text" id="user-Address" name="address" class="form-control" placeholder="address" required>

            @if (TempData["Error"] != null)
            {
                <div class="alert alert-danger">
                    @TempData["Error"]
                </div>
            }

            @if (TempData["Success"] != null)
            {
                <div class="alert alert-success">
                    @TempData["Success"]
                </div>
            }

            <button class="btn btn-primary btn-block" type="submit">
                <i class="fas fa-user-plus"></i> Sign Up
            </button>

            <a href="#" id="cancel_signup"><i class="fas fa-angle-left"></i> Back</a>
        </form>

        <!-- Popup OTP -->
        <div id="otpModal" class="modal">
            <div class="modal-content">
                <h2>Nhập Mã OTP</h2>
                <input type="text" id="otp-input" class="form-control" placeholder="Nhập mã OTP">
                <button id="verify-otp" class="btn btn-success">Confirm</button>
                <button class="btn btn-danger" onclick="closeOTPModal()">Back</button>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div class="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Loading...</span>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script src="/script.js"></script>

    <script>
        // Hàm chuyển đổi giữa form đăng nhập và form đặt lại mật khẩu
        function toggleResetPswd(e) {
            e.preventDefault();
            $('#logreg-forms .form-signin').toggle();
            $('#logreg-forms .form-reset').toggle();
        }

        // Hàm chuyển đổi giữa form đăng nhập và form đăng ký
        function toggleSignUp(e) {
            e.preventDefault();
            $('#logreg-forms .form-signin').toggle();
            $('#logreg-forms .form-signup').toggle();
        }

        // Gắn sự kiện khi DOM đã sẵn sàng
        $(document).ready(function () {
            $('#logreg-forms #forgot_pswd').click(toggleResetPswd);
            $('#logreg-forms #cancel_reset').click(toggleResetPswd);
            $('#logreg-forms #btn-signup').click(toggleSignUp);
            $('#logreg-forms #cancel_signup').click(toggleSignUp);

            // Xử lý form đăng ký
            $(".form-signup").submit(function (event) {
                event.preventDefault(); // Ngăn form submit mặc định

                var formData = $(this).serialize(); // Lấy dữ liệu form
                $(".loading").show(); // Hiển thị loading

                $.ajax({
                    type: "POST",
                    url: "/LoginASignUp/SignUp",
                    data: formData,
                    success: function (response) {
                        $(".loading").hide(); // Ẩn loading
                        if (response.success) {
                            $("#otpModal").show(); // Hiển thị popup nhập OTP
                        } else {
                            alert(response.message); // Hiển thị lỗi nếu có
                        }
                    },
                    error: function (xhr, status, error) {
                        $(".loading").hide(); // Ẩn loading
                        alert("Đã xảy ra lỗi: " + (xhr.responseJSON?.message || "Không thể kết nối đến server."));
                    }
                });
            });

            // Xác nhận OTP
            $("#verify-otp").click(function () {
                var enteredOTP = $("#otp-input").val();
                if (!enteredOTP) {
                    alert("Vui lòng nhập mã OTP!");
                    return;
                }

                $(".loading").show(); // Hiển thị loading

                $.ajax({
                    type: "POST",
                    url: "/LoginASignUp/VerifyOTP",
                    data: { otp: enteredOTP },
                    success: function (response) {
                        $(".loading").hide(); // Ẩn loading
                        if (response.success) {
                            alert("Đăng ký thành công!");
                            window.location.href = "/LoginASignUp"; // Điều hướng về trang đăng nhập
                        } else {
                            alert(response.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        $(".loading").hide(); // Ẩn loading
                        alert("Đã xảy ra lỗi: " + (xhr.responseJSON?.message || "Không thể kết nối đến server."));
                    }
                });
            });

            // Đóng modal OTP
            $("#otpModal").click(function (e) {
                if (e.target === this) {
                    closeOTPModal();
                }
            });

            // Đóng modal bằng phím ESC
            $(document).keydown(function (e) {
                if (e.key === "Escape" && $("#otpModal").is(":visible")) {
                    closeOTPModal();
                }
            });
        });

        function closeOTPModal() {
            $("#otpModal").hide();
            $("#otp-input").val(""); // Xóa giá trị OTP khi đóng
        }

        // Xử lý sự kiện "Back" trên form đăng ký
        document.getElementById("cancel_signup").addEventListener("click", function (event) {
            event.preventDefault();
            window.history.back(); // Quay lại trang trước đó
        });

    </script>

    <p style="text-align:center">
        <a href="http://bit.ly/2RjWFM" target="_blank" style="color:black"></a>
    </p>
</body>
</html>